// client/src/components/purchase/PurchaseRequestPage.tsx
import React, { useState, useMemo } from 'react';
import styled from 'styled-components';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { toast } from 'react-toastify';
import { 
  Plus, 
  Download, 
  RefreshCw, 
  Eye,
  Edit,
  Trash2,
  Check,
  X,
  Clock,
  AlertCircle,
  FileText,
  Upload,
  Filter,
  Package2, 
  CheckCircle2,
  TrendingUp,
  Users,
  Calendar
} from 'lucide-react';

// Components
import Table from '../common/Table';
import Pagination from '../common/Pagination';
import LoadingSpinner from '../common/LoadingSpinner';
import Card from '../common/Card';
import Modal from '../common/Modal';
import Button from '../common/Button';
import PurchaseRequestForm from './PurchaseRequestForm';
import ExcelBulkUpload from './ExcelBulkUpload';
import PurchaseRequestFilters from './PurchaseRequestFilters';
import RequestDetailModal from './RequestDetailModal';
import { useNavigate } from 'react-router-dom';

// Services
import api, { purchaseApi, inventoryApi } from '../../services/api';

// SearchFilters ÌÉÄÏûÖ Ï†ïÏùò
interface SearchFilters {
  search?: string;
  status?: string;
  urgency?: string;
  department?: string;
  category?: string;
  dateFrom?: string;
  dateTo?: string;
}

// Types - APIÏôÄ ÎßûÏ∂§
interface PurchaseRequest {
  id: number;
  item_name: string;
  specifications?: string;
  quantity: number;
  unit?: string;
  estimated_unit_price?: number;
  total_budget?: number;
  currency?: string;
  category?: string;
  urgency: string;
  requester_name: string;
  requester_email?: string;
  department: string;
  status: string;
  created_at: string;
  justification: string;
  notes?: string;
  inventory_item_id?: number;
  inventory_item_code?: string;
  preferred_supplier?: string;
}

interface TableColumn<T> {
  key: keyof T | string;
  label: string;
  sortable?: boolean;
  width?: string;
  render?: (value: any, item: T) => React.ReactNode;
}

type RequestStatus = 'all' | 'pending' | 'approved' | 'rejected' | 'in_review';
type UrgencyLevel = 'all' | 'low' | 'normal' | 'high' | 'urgent';

// üé® Í∞úÏÑ†Îêú Styled Components (Îëê Î≤àÏß∏ ÏΩîÎìúÏóêÏÑú Í∞ÄÏ†∏Ïò¥)
const Container = styled.div`
  padding: 24px;
  max-width: 1400px;
  margin: 0 auto;
`;

const PageHeader = styled.div`
  margin-bottom: 32px;
`;

const PageTitle = styled.h1`
  font-size: 2rem;
  font-weight: 600;
  margin-bottom: 8px;
  color: #1f2937;
`;

const PageSubtitle = styled.p`
  color: #6b7280;
  margin-bottom: 0;
  font-size: 1rem;
  line-height: 1.5;
`;

const StatsContainer = styled.div`
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 20px;
  margin-bottom: 32px;
  
  @media (max-width: 768px) {
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
  }
`;

const StatCard = styled(Card)<{ $color?: string }>`
  text-align: center;
  background: ${props => props.$color ? `linear-gradient(135deg, ${props.$color}15 0%, ${props.$color}08 100%)` : 'white'};
  border-left: 4px solid ${props => props.$color || '#3b82f6'};
  padding: 24px 20px;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  
  &:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
  }
  
  .stat-header {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-bottom: 16px;
    color: ${props => props.$color || '#3b82f6'};
    font-weight: 500;
  }
  
  .stat-value {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 8px;
    color: ${props => props.$color || '#3b82f6'};
    line-height: 1;
  }
  
  .stat-label {
    font-size: 0.875rem;
    color: #6b7280;
    margin-bottom: 12px;
  }
  
  .stat-change {
    font-size: 0.75rem;
    padding: 4px 8px;
    border-radius: 12px;
    font-weight: 500;
    display: inline-block;
    
    &.positive {
      background: #10b98120;
      color: #10b981;
    }
    
    &.negative {
      background: #ef444420;
      color: #ef4444;
    }
  }
`;

const ContentCard = styled(Card)`
  padding: 0;
  overflow: hidden;
`;

const FilterSection = styled.div`
  padding: 20px 24px;
  border-bottom: 1px solid #e5e7eb;
  background: #f9fafb;
`;

const FilterContainer = styled.div`
  display: flex;
  gap: 16px;
  align-items: flex-start;
  justify-content: space-between;
  
  @media (max-width: 1024px) {
    flex-direction: column;
    gap: 16px;
  }
`;

const ActionButtons = styled.div`
  display: flex;
  gap: 8px;
  flex-shrink: 0;
  
  @media (max-width: 1024px) {
    width: 100%;
    justify-content: flex-end;
  }
  
  @media (max-width: 768px) {
    justify-content: stretch;
    
    > button {
      flex: 1;
      min-width: 0;
      
      span {
        display: none;
      }
      
      svg {
        margin: 0;
      }
    }
  }
`;

const TableContainer = styled.div`
  padding: 24px;
`;

const StatusBadge = styled.span<{ $status: string }>`
  padding: 4px 12px;
  border-radius: 16px;
  font-size: 12px;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  
  ${props => {
    switch (props.$status) {
      case 'SUBMITTED':
        return `
          background: #FEF3C7;
          color: #92400E;
        `;
      case 'COMPLETED':
        return `
          background: #D1FAE5;
          color: #065F46;
        `;
      case 'CANCELLED':
        return `
          background: #FEE2E2;
          color: #991B1B;
        `;
      case 'IN_REVIEW':
        return `
          background: #DBEAFE;
          color: #1E40AF;
        `;
      default:
        return `
          background: #F3F4F6;
          color: #374151;
        `;
    }
  }}
`;

const UrgencyBadge = styled.span<{ $urgency: string }>`
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  
  ${props => {
    switch (props.$urgency) {
      case 'urgent':
        return `
          background: #fee2e2;
          color: #991b1b;
        `;
      case 'high':
        return `
          background: #fed7aa;
          color: #9a3412;
        `;
      case 'normal':
        return `
          background: #dbeafe;
          color: #1e40af;
        `;
      case 'low':
        return `
          background: #d1fae5;
          color: #065f46;
        `;
      default:
        return `
          background: #f3f4f6;
          color: #374151;
        `;
    }
  }}
`;

const ActionButtonGroup = styled.div`
  display: flex;
  gap: 5px;
`;

const ErrorContainer = styled.div`
  text-align: center;
  padding: 60px 20px;
  
  .error-icon {
    color: #ef4444;
    margin-bottom: 16px;
  }
  
  .error-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 8px;
    color: #1f2937;
  }
  
  .error-message {
    color: #6b7280;
    margin-bottom: 24px;
    line-height: 1.6;
  }
`;

const EmptyState = styled.div`
  text-align: center;
  padding: 60px 20px;
  color: #6b7280;
  
  .empty-icon {
    margin-bottom: 16px;
    color: #d1d5db;
  }
  
  .empty-title {
    font-size: 1.125rem;
    font-weight: 500;
    margin-bottom: 8px;
    color: #374151;
  }
  
  .empty-message {
    margin-bottom: 24px;
    line-height: 1.6;
  }
`;

const ConfirmDialog = styled.div`
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
`;

const ConfirmContent = styled.div`
  background: white;
  padding: 32px;
  border-radius: 16px;
  box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
  max-width: 500px;
  width: 90%;
  text-align: center;
  
  .confirm-icon {
    width: 64px;
    height: 64px;
    background: linear-gradient(135deg, #10b981, #059669);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 20px;
    color: white;
  }
  
  .confirm-title {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 12px;
    color: #1f2937;
  }
  
  .confirm-message {
    color: #6b7280;
    margin-bottom: 8px;
    line-height: 1.5;
  }
  
  .item-info {
    background: #f9fafb;
    padding: 16px;
    border-radius: 8px;
    margin: 20px 0;
    text-align: left;
    
    .info-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      
      &:last-child {
        margin-bottom: 0;
      }
      
      .label {
        font-weight: 500;
        color: #6b7280;
        min-width: 80px;
      }
      
      .value {
        font-weight: 600;
        color: #1f2937;
        flex: 1;
      }
    }
  }
  
  .button-group {
    display: flex;
    gap: 12px;
    justify-content: center;
    margin-top: 24px;
  }
`;

// Î©îÏù∏ Ïª¥Ìè¨ÎÑåÌä∏
const PurchaseRequestPage: React.FC = () => {
  const navigate = useNavigate();
  const queryClient = useQueryClient();
  
  // State
  const [currentPage, setCurrentPage] = useState(1);
  const [filters, setFilters] = useState<SearchFilters>({});
  const [isFormModalOpen, setIsFormModalOpen] = useState(false);
  const [isExcelModalOpen, setIsExcelModalOpen] = useState(false);
  const [editingRequest, setEditingRequest] = useState<PurchaseRequest | null>(null);
  const [viewingRequest, setViewingRequest] = useState<PurchaseRequest | null>(null);
  const [isDetailModalOpen, setIsDetailModalOpen] = useState(false);
  const [confirmingItem, setConfirmingItem] = useState<PurchaseRequest | null>(null);

  // Íµ¨Îß§ ÏöîÏ≤≠ Î™©Î°ù Ï°∞Ìöå
  const { 
    data: requestsData, 
    isLoading, 
    error,
    refetch 
  } = useQuery({
    queryKey: ['purchase-requests', currentPage, filters],
    queryFn: () => purchaseApi.getRequests({ page: currentPage, limit: 20, ...filters }),
    keepPreviousData: true,
    staleTime: 5 * 60 * 1000,
    retry: 2,
  });

  // ÌÜµÍ≥Ñ Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå
  const { data: statsData } = useQuery({
    queryKey: ['purchase-requests-stats'],
    queryFn: () => purchaseApi.getStats(),
    staleTime: 5 * 60 * 1000,
  });

  // üî• ÏïàÏ†ïÏ†ÅÏù∏ Íµ¨Îß§ÏôÑÎ£å Ï≤òÎ¶¨ (Ï≤´ Î≤àÏß∏ ÏΩîÎìúÏùò Î°úÏßÅ ÏÇ¨Ïö©)
  const completePurchaseMutation = useMutation({
    mutationFn: async ({ requestId, requestData }: { 
      requestId: number; 
      requestData: PurchaseRequest;
    }) => {
      console.log('üöÄ Íµ¨Îß§ÏôÑÎ£å + ÌíàÎ™© Îì±Î°ù ÏãúÏûë:', { requestId, requestData });
      
      try {
        // 1Ô∏è‚É£ Î®ºÏ†Ä Íµ¨Îß§ ÏöîÏ≤≠ ÏÉÅÌÉúÎ•º COMPLETEDÎ°ú Î≥ÄÍ≤Ω
        console.log('üìù 1Îã®Í≥Ñ: Íµ¨Îß§ ÏöîÏ≤≠ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏');
        const updateResult = await purchaseApi.updateRequest(requestId, {
          status: 'COMPLETED',
          completed_date: new Date().toISOString(),
          completed_by: 'ÌòÑÏû¨ÏÇ¨Ïö©Ïûê'
        });
        console.log('‚úÖ Íµ¨Îß§ ÏöîÏ≤≠ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ ÏÑ±Í≥µ:', updateResult);

        // 2Ô∏è‚É£ ÌíàÎ™©Í¥ÄÎ¶¨Ïóê ÏÉà ÌíàÎ™© Îì±Î°ù
        console.log('üì¶ 2Îã®Í≥Ñ: ÌíàÎ™©Í¥ÄÎ¶¨Ïóê Îì±Î°ù');
        
        // Íµ¨Îß§ ÏöîÏ≤≠ Îç∞Ïù¥ÌÑ∞Î•º ÌíàÎ™©Í¥ÄÎ¶¨Ïö© Îç∞Ïù¥ÌÑ∞Î°ú Î≥ÄÌôò
        const inventoryData = {
          item_code: `ITM-${new Date().toISOString().split('T')[0].replace(/-/g, '')}-${requestId.toString().padStart(4, '0')}`,
          item_name: requestData.item_name || 'ÌíàÎ™©Î™Ö ÏóÜÏùå',
          category: requestData.category || 'OTHER',
          description: requestData.specifications || `Íµ¨Îß§ÏöîÏ≤≠ #${requestId}ÏóêÏÑú ÏûêÎèô ÏÉùÏÑ±`,
          current_stock: Number(requestData.quantity) || 0,
          minimum_stock: Math.max(1, Math.ceil((Number(requestData.quantity) || 0) * 0.2)),
          maximum_stock: (Number(requestData.quantity) || 0) * 2,
          unit: requestData.unit || 'Í∞ú',
          unit_price: Number(requestData.estimated_unit_price) || 0,
          currency: requestData.currency || 'KRW',
          supplier_name: requestData.preferred_supplier || '',
          location: 'Ï∞ΩÍ≥†',
          warehouse: 'Î©îÏù∏Ï∞ΩÍ≥†',
          purchase_request_id: requestId,
          notes: `Íµ¨Îß§ÏöîÏ≤≠ #${requestId}ÏóêÏÑú ÏûêÎèô ÏÉùÏÑ±Îê®`,
          is_active: true,
          created_by: 'ÌòÑÏû¨ÏÇ¨Ïö©Ïûê',
          department: requestData.department
        };

        console.log('üì§ ÌíàÎ™© Îì±Î°ù Îç∞Ïù¥ÌÑ∞:', inventoryData);
        
        // ÌíàÎ™©Í¥ÄÎ¶¨ API Ìò∏Ï∂ú (inventoryApi ÏÇ¨Ïö©)
        const inventoryResult = await inventoryApi.createItem(inventoryData);
        console.log('‚úÖ ÌíàÎ™© Îì±Î°ù ÏÑ±Í≥µ:', inventoryResult);

        return {
          success: true,
          purchase_update: updateResult,
          inventory_created: inventoryResult,
          inventory_item_id: inventoryResult.data?.id,
          inventory_item_code: inventoryData.item_code,
          message: 'Íµ¨Îß§ÏôÑÎ£å Î∞è ÌíàÎ™© Îì±Î°ù ÏÑ±Í≥µ'
        };

      } catch (error) {
        console.error('‚ùå Ï≤òÎ¶¨ Ï§ë Ïò§Î•ò:', error);
        
        // Î∂ÄÎ∂Ñ Ïã§Ìå® Ï≤òÎ¶¨: Íµ¨Îß§ ÏöîÏ≤≠ÏùÄ ÏÑ±Í≥µÌñàÏßÄÎßå ÌíàÎ™© Îì±Î°ù Ïã§Ìå®
        if (error.message?.includes('inventory') || error.response?.status) {
          console.warn('‚ö†Ô∏è ÌíàÎ™© Îì±Î°ù Ïã§Ìå®, Íµ¨Îß§ ÏöîÏ≤≠Îßå ÏôÑÎ£åÎê®');
          return {
            success: true,
            partial_success: true,
            purchase_update: true,
            inventory_created: false,
            message: 'Íµ¨Îß§ ÏöîÏ≤≠ÏùÄ ÏôÑÎ£åÎêòÏóàÏßÄÎßå ÌíàÎ™© Îì±Î°ùÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.',
            error: error.message
          };
        }
        
        throw error;
      }
    },
    
    // üî• Ïû¨ÏãúÎèÑ ÏÑ§Ï†ï Ï∂îÍ∞Ä
    retry: (failureCount, error: any) => {
      // ÏµúÎåÄ 2Î≤àÍπåÏßÄÎßå Ïû¨ÏãúÎèÑ
      if (failureCount >= 2) return false;
      
      // Ìä∏ÎûúÏû≠ÏÖò Ïò§Î•òÎÇò 500 ÏóêÎü¨Ïù∏ Í≤ΩÏö∞ÏóêÎßå Ïû¨ÏãúÎèÑ
      const shouldRetry = error.response?.status === 500 || 
                         error.response?.data?.detail?.includes('transaction is aborted');
      
      if (shouldRetry) {
        console.log(`üîÑ Ïû¨ÏãúÎèÑ ${failureCount + 1}/2`);
        return true;
      }
      
      return false;
    },
    
    // Ïû¨ÏãúÎèÑ Í∞ÑÍ≤© (Ï†êÏßÑÏ†Å Ï¶ùÍ∞Ä)
    retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 5000),

    onSuccess: async (result, variables) => {
      console.log('üéâ Íµ¨Îß§ÏôÑÎ£å Ï≤òÎ¶¨ Í≤∞Í≥º:', result);
      
      try {
        // Ï∫êÏãú ÏóÖÎç∞Ïù¥Ìä∏
        queryClient.setQueryData(['purchase-requests', currentPage, filters], (oldData: any) => {
          if (!oldData?.data?.items) return oldData;
          
          return {
            ...oldData,
            data: {
              ...oldData.data,
              items: oldData.data.items.map((item: any) => {
                if (item.id === variables.requestId) {
                  return {
                    ...item,
                    status: 'COMPLETED',
                    completed_date: new Date().toISOString(),
                    completed_by: 'ÌòÑÏû¨ÏÇ¨Ïö©Ïûê',
                    inventory_item_id: result.inventory_item_id,
                    inventory_item_code: result.inventory_item_code
                  };
                }
                return item;
              })
            }
          };
        });
        
        // ÏÑ±Í≥µ Î©îÏãúÏßÄ ÌëúÏãú
        if (result.inventory_created !== false) {
          // ÏôÑÏ†Ñ ÏÑ±Í≥µ
          toast.success(
            `üéâ Íµ¨Îß§ÏôÑÎ£å! ÌíàÎ™©ÏΩîÎìú: ${result.inventory_item_code}Î°ú Îì±Î°ùÎêòÏóàÏäµÎãàÎã§!`,
            { autoClose: 5000, position: 'top-center' }
          );
          
          // ÌíàÎ™©Í¥ÄÎ¶¨ ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
          setTimeout(() => {
            navigate(`/inventory?highlight=${result.inventory_item_id}`);
          }, 2000);
          
        } else {
          // Î∂ÄÎ∂Ñ ÏÑ±Í≥µ
          toast.warning(
            'Íµ¨Îß§ ÏöîÏ≤≠ÏùÄ ÏôÑÎ£åÎêòÏóàÏßÄÎßå ÌíàÎ™© Îì±Î°ùÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. ÏàòÎèôÏúºÎ°ú Îì±Î°ùÌï¥Ï£ºÏÑ∏Ïöî.',
            { autoClose: 7000 }
          );
        }
        
        // üî• ÏøºÎ¶¨ ÏÉàÎ°úÍ≥†Ïπ®ÏùÑ ÏàúÏ∞®Ï†ÅÏúºÎ°ú Ïã§Ìñâ (ÎèôÏãúÏÑ± Î¨∏Ï†ú Î∞©ÏßÄ)
        await queryClient.invalidateQueries({ queryKey: ['purchase-requests'] });
        await new Promise(resolve => setTimeout(resolve, 200));
        
        await queryClient.invalidateQueries({ queryKey: ['purchase-requests-stats'] });
        await new Promise(resolve => setTimeout(resolve, 200));
        
        await queryClient.invalidateQueries({ queryKey: ['inventory'] });
        await new Promise(resolve => setTimeout(resolve, 200));
        
        await queryClient.invalidateQueries({ queryKey: ['inventory-stats'] });
        
        setConfirmingItem(null);
        
      } catch (error) {
        console.error('ÏÑ±Í≥µ ÌõÑ Ï≤òÎ¶¨ Ï§ë Ïò§Î•ò:', error);
        toast.warning('Íµ¨Îß§Îäî ÏôÑÎ£åÎêòÏóàÏúºÎÇò ÌôîÎ©¥ ÏÉàÎ°úÍ≥†Ïπ® Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï¥Ï£ºÏÑ∏Ïöî.');
        setConfirmingItem(null);
      }
    },
    
    onError: (error: any) => {
      console.error('‚ùå Íµ¨Îß§ÏôÑÎ£å Ï≤òÎ¶¨ Ïã§Ìå®:', error);
      
      // ÏóêÎü¨ Î©îÏãúÏßÄ Ï∂îÏ∂ú Î∞è Í∞úÏÑ†
      let errorMessage = 'Íµ¨Îß§ÏôÑÎ£å Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
      
      if (error.message) {
        errorMessage = error.message;
      } else if (error.response?.data?.detail) {
        // Ìä∏ÎûúÏû≠ÏÖò Ïò§Î•ò Î©îÏãúÏßÄ Í∞úÏÑ†
        if (error.response.data.detail.includes('transaction is aborted')) {
          errorMessage = '‚ö†Ô∏è Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ï≤òÎ¶¨ Ï§ë Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.\n\nÏû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌïòÍ±∞ÎÇò, ÏßÄÏÜçÏ†ÅÏúºÎ°ú Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌïòÎ©¥ Í¥ÄÎ¶¨ÏûêÏóêÍ≤å Î¨∏ÏùòÌï¥Ï£ºÏÑ∏Ïöî.';
        } else {
          errorMessage = error.response.data.detail;
        }
      } else if (error.response?.data?.message) {
        errorMessage = error.response.data.message;
      }
      
      toast.error(errorMessage, {
        autoClose: 7000,
        position: 'top-center'
      });
      
      setConfirmingItem(null);
    },
  });

  // ÏÇ≠Ï†ú Mutation
  const deleteMutation = useMutation({
    mutationFn: purchaseApi.deleteRequest,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['purchase-requests'] });
      queryClient.invalidateQueries({ queryKey: ['purchase-requests-stats'] });
      toast.success('Íµ¨Îß§ ÏöîÏ≤≠Ïù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
    },
    onError: (error: any) => {
      toast.error(error.response?.data?.message || 'ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
    },
  });

  // Export Mutation
  const exportMutation = useMutation({
    mutationFn: () => purchaseApi.exportRequests(filters),
    onSuccess: () => {
      toast.success('Excel ÌååÏùºÏù¥ Îã§Ïö¥Î°úÎìúÎêòÏóàÏäµÎãàÎã§.');
    },
    onError: (error) => {
      console.error('Export error:', error);
      toast.error('Excel Îã§Ïö¥Î°úÎìúÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
    },
  });

  // ÌÖåÏù¥Î∏î Ïª¨Îüº Ï†ïÏùò
  const columns: TableColumn<PurchaseRequest>[] = useMemo(() => [
    {
      key: 'id',
      label: 'Î≤àÌò∏',
      sortable: true,
      width: '80px',
      render: (value) => (
        <span style={{ fontFamily: 'monospace', fontSize: '0.9rem', fontWeight: '500' }}>
          #{value}
        </span>
      ),
    },
    {
      key: 'item_name',
      label: 'ÌíàÎ™©Î™Ö',
      sortable: true,
      width: '200px',
      render: (value, item) => (
        <div>
          <div style={{ fontWeight: 'bold', marginBottom: '4px' }}>{value || 'ÌíàÎ™©Î™Ö ÏóÜÏùå'}</div>
        </div>
      ),
    },
    {
      key: 'quantity',
      label: 'ÏàòÎüâ',
      width: '80px',
      render: (value, item) => (
        <div style={{ 
          textAlign: 'center', 
          fontWeight: '500',
          whiteSpace: 'nowrap'  // Ï§ÑÎ∞îÍøà Î∞©ÏßÄ
        }}>
          {value?.toLocaleString() || '0'} {item.unit || 'Í∞ú'}
        </div>
      ),
    },
    {
      key: 'requester_name',
      label: 'ÏöîÏ≤≠Ïûê',
      width: '120px',
      render: (value, item) => (
        <div>
          <div style={{ fontWeight: '500' }}>{value}</div>
          <div style={{ fontSize: '12px', color: '#6b7280' }}>{item.department}</div>
        </div>
      ),
    },
    {
      key: 'urgency',
      label: 'Í∏¥Í∏âÎèÑ',
      width: '100px',
      render: (value) => {
        const urgencyMap: Record<string, string> = {
          'low': 'ÎÇÆÏùå',
          'normal': 'Î≥¥ÌÜµ',
          'high': 'ÎÜíÏùå', 
          'urgent': 'Í∏¥Í∏â',
          'emergency': 'ÏùëÍ∏â'
        };
        return <UrgencyBadge $urgency={value}>{urgencyMap[value] || value}</UrgencyBadge>;
      },
    },
    {
      key: 'status',
      label: 'ÏÉÅÌÉú',
      width: '120px',
      render: (value) => {
        const statusMap: Record<string, string> = {
          'SUBMITTED': 'ÏöîÏ≤≠Îê®',
          'COMPLETED': 'Íµ¨Îß§ÏôÑÎ£å', 
          'CANCELLED': 'Ï∑®ÏÜåÎê®'
        };
        return <StatusBadge $status={value}>{statusMap[value] || value}</StatusBadge>;
      },
    },
    {
      key: 'created_at',
      label: 'ÏöîÏ≤≠Ïùº',
      sortable: true,
      width: '120px',
      render: (value) => value ? new Date(value).toLocaleDateString('ko-KR') : '-',
    },
    {
      key: 'total_budget',
      label: 'ÏòàÏÉÅÍ∏àÏï°',
      width: '160px',
      render: (value, item) => {
        if (!value || value === 0) return '-';
        const currency = item.currency || 'Ïõê';
        return `${currency} ${value.toLocaleString()}`;
      },
    },
    {
      key: 'actions',
      label: 'Í¥ÄÎ¶¨',
      width: '160px',
      render: (_, item) => {
        const isCompleted = item.status === 'COMPLETED';
        const hasInventoryItem = item.inventory_item_id || item.inventory_item_code;
        
        return (
          <ActionButtonGroup>
            {/* üî• ÏôÑÎ£å ÏÉÅÌÉúÏôÄ ÌíàÎ™© Îì±Î°ù Ïó¨Î∂ÄÏóê Îî∞Î•∏ Î≤ÑÌäº ÌëúÏãú */}
            {isCompleted ? (
              hasInventoryItem ? (
                // ‚úÖ ÏôÑÏ†Ñ ÏôÑÎ£å (ÌíàÎ™©ÍπåÏßÄ Îì±Î°ùÎê®)
                <Button
                  size="sm"
                  variant="outline"
                  title={`Íµ¨Îß§ÏôÑÎ£å & ÌíàÎ™©Îì±Î°ù ÏôÑÎ£å ${item.inventory_item_code ? `(${item.inventory_item_code})` : ''}`}
                  onClick={() => {
                    if (item.inventory_item_id) {
                      navigate(`/inventory?highlight=${item.inventory_item_id}`);
                    }
                  }}
                  style={{
                    background: '#f0fdf4',
                    color: '#16a34a',
                    border: '1px solid #16a34a'
                  }}
                  disabled={!item.inventory_item_id}
                >
                  <Package2 size={14} />
                  ÏôÑÎ£åÎê®
                </Button>
              ) : (
                // ‚ö†Ô∏è Î∂ÄÎ∂Ñ ÏôÑÎ£å (Íµ¨Îß§Îßå ÏôÑÎ£å, ÌíàÎ™© Îì±Î°ù ÏïàÎê®)
                <Button
                  size="sm"
                  variant="outline"
                  title="Íµ¨Îß§ÏôÑÎ£åÎê® (ÌíàÎ™© Îì±Î°ù Ïã§Ìå®)"
                  disabled
                  style={{
                    background: '#f3f4f6',
                    color: '#6b7280',
                    border: '1px solid #6b7280'
                  }}
                >
                  <Check size={14} />
                  Íµ¨Îß§ÏôÑÎ£å
                </Button>
              )
            ) : (
              // üü¢ ÎØ∏ÏôÑÎ£å - Íµ¨Îß§ÏôÑÎ£å Î≤ÑÌäº
              <Button
                size="sm"
                variant="success"
                onClick={() => handlePurchaseComplete(item)}
                title="Íµ¨Îß§ÏôÑÎ£å + ÌíàÎ™©Îì±Î°ù"
                style={{
                  background: 'linear-gradient(135deg, #3b82f6, #1d4ed8)',
                  color: 'white',
                  fontWeight: '600'
                }}
              >
                <CheckCircle2 size={14} />
                Íµ¨Îß§ÏôÑÎ£å
              </Button>
            )}
            <Button
              size="sm"
              variant="outline"
              onClick={() => handleView(item)}
              title="ÏÉÅÏÑ∏Î≥¥Í∏∞"
            >
              <Eye size={14} />
            </Button>
            <Button
              size="sm"
              variant="outline"
              onClick={() => handleEdit(item)}
              title="ÏàòÏ†ï"
            >
              <Edit size={14} />
            </Button>
            
            <Button
              size="sm"
              variant="danger"
              onClick={() => handleDelete(item.id)}
              title="ÏÇ≠Ï†ú"
            >
              <Trash2 size={14} />
            </Button>
          </ActionButtonGroup>
        );
      },
    }],
 []);

  // Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨
  const handleView = (request: PurchaseRequest) => {
    console.log('ÏÉÅÏÑ∏Î≥¥Í∏∞ Îç∞Ïù¥ÌÑ∞:', request);
    setViewingRequest(request);
    setIsDetailModalOpen(true);
  };

  const handleEdit = (request: PurchaseRequest) => {
    setEditingRequest(request);
    setIsFormModalOpen(true);
  };

  const handleDelete = async (requestId: number) => {
    if (window.confirm('Ï†ïÎßêÎ°ú Ïù¥ Íµ¨Îß§ ÏöîÏ≤≠ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
      deleteMutation.mutate(requestId);
    }
  };

  const handleExport = () => {
    exportMutation.mutate();
  };

  // üî• Í∞úÏÑ†Îêú ÏÉàÎ°úÍ≥†Ïπ® Ìï®Ïàò
  const handleRefresh = async () => {
    try {
      // ÏàúÏ∞®Ï†ÅÏúºÎ°ú ÏÉàÎ°úÍ≥†Ïπ® (ÎèôÏãúÏÑ± Î¨∏Ï†ú Î∞©ÏßÄ)
      await queryClient.invalidateQueries({ queryKey: ['purchase-requests'] });
      await new Promise(resolve => setTimeout(resolve, 100));
      
      await queryClient.invalidateQueries({ queryKey: ['purchase-requests-stats'] });
      await new Promise(resolve => setTimeout(resolve, 100));
      
      await refetch();
    } catch (error) {
      console.error('ÏÉàÎ°úÍ≥†Ïπ® Ï§ë Ïò§Î•ò:', error);
      toast.error('ÏÉàÎ°úÍ≥†Ïπ® Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
    }
  };

  const handleFilterChange = (newFilters: Partial<SearchFilters>) => {
    setFilters(prev => ({ ...prev, ...newFilters }));
    setCurrentPage(1);
  };

  const handleFormSuccess = () => {
    setIsFormModalOpen(false);
    setEditingRequest(null);
    handleRefresh();
  };

  const handleFormCancel = () => {
    setIsFormModalOpen(false);
    setEditingRequest(null);
  };

  const handleExcelSuccess = () => {
    setIsExcelModalOpen(false);
    handleRefresh();
  };

  const handlePurchaseComplete = (request: PurchaseRequest) => {
    console.log('üîÑ Íµ¨Îß§ÏôÑÎ£å Ï≤òÎ¶¨ ÏöîÏ≤≠:', request);
    setConfirmingItem(request);
  };

  // üî• Í∞úÏÑ†Îêú Íµ¨Îß§ÏôÑÎ£å ÌôïÏù∏ Ìï®Ïàò
  const confirmPurchaseComplete = async () => {
    if (!confirmingItem) return;
    
    console.log('üÜï Íµ¨Îß§ÏôÑÎ£å + ÌíàÎ™©Îì±Î°ù Ï≤òÎ¶¨ ÏãúÏûë');
    
    try {
      // Ï§ëÎ≥µ ÌÅ¥Î¶≠ Î∞©ÏßÄ
      if (completePurchaseMutation.isPending) {
        console.log('‚ö†Ô∏è Ïù¥ÎØ∏ Ï≤òÎ¶¨ Ï§ëÏûÖÎãàÎã§.');
        return;
      }
      
      // Íµ¨Îß§ ÏöîÏ≤≠ Îç∞Ïù¥ÌÑ∞ÏôÄ Ìï®Íªò Ï†ÑÎã¨
      await completePurchaseMutation.mutateAsync({
        requestId: confirmingItem.id,
        requestData: confirmingItem
      });
      
    } catch (error) {
      // Ïù¥ÎØ∏ onErrorÏóêÏÑú Ï≤òÎ¶¨Îê®
      console.log('Íµ¨Îß§ÏôÑÎ£å Ï≤òÎ¶¨Í∞Ä Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
    }
  };

  const cancelPurchaseComplete = () => {
    setConfirmingItem(null);
  };

  // Îç∞Ïù¥ÌÑ∞ Ï∂îÏ∂ú
  const requests = requestsData?.data?.items || [];
  const totalPages = requestsData?.data?.pages || 0;
  const totalItems = requestsData?.data?.total || 0;
  const stats = statsData?.data || {
    total: 0,
    pending: 0,
    approved: 0,
    rejected: 0,
    this_month: 0,
  };

  // üî• ÌÜµÍ≥Ñ Í≥ÑÏÇ∞ (Ïã§Ï†ú API Îç∞Ïù¥ÌÑ∞ÏôÄ ÌòÑÏû¨ Îç∞Ïù¥ÌÑ∞ Î™®Îëê ÏÇ¨Ïö©)
  const totalRequests = stats?.total || requests.length || 0;
  const completedRequests = stats?.approved || requests.filter(req => req.status === 'COMPLETED').length || 0;
  const pendingRequests = stats?.pending || requests.filter(req => req.status === 'SUBMITTED' || req.status === 'PENDING').length || 0;
  const rejectedRequests = stats?.rejected || requests.filter(req => req.status === 'CANCELLED' || req.status === 'REJECTED').length || 0;

  if (isLoading && !requestsData) {
    return <LoadingSpinner text="Íµ¨Îß§ ÏöîÏ≤≠ Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë..." />;
  }

  if (error) {
    console.error('Purchase requests error:', error);
    return (
      <Container>
        <PageHeader>
          <PageTitle>Íµ¨Îß§ ÏöîÏ≤≠ Í¥ÄÎ¶¨</PageTitle>
        </PageHeader>
        <Card>
          <ErrorContainer>
            <AlertCircle size={48} className="error-icon" />
            <div className="error-title">Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§</div>
            <div className="error-message">
              Î∞±ÏóîÎìú ÏÑúÎ≤ÑÍ∞Ä Ïã§ÌñâÎêòÏßÄ ÏïäÏïòÍ±∞ÎÇò Íµ¨Îß§ ÏöîÏ≤≠ APIÍ∞Ä Íµ¨ÌòÑÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.
              <br />
              ÏÑúÎ≤Ñ ÏÉÅÌÉúÎ•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.
            </div>
            <Button onClick={handleRefresh} disabled={isLoading}>
              <RefreshCw size={16} />
              Îã§Ïãú ÏãúÎèÑ
            </Button>
          </ErrorContainer>
        </Card>
      </Container>
    );
  }

  return (
    <Container>
      <PageHeader>
        <PageTitle>Íµ¨Îß§ ÏöîÏ≤≠ Í¥ÄÎ¶¨</PageTitle>
        <PageSubtitle>
          Íµ¨Îß§ ÏöîÏ≤≠ÏùÑ Îì±Î°ùÌïòÍ≥† ÏäπÏù∏ ÌîÑÎ°úÏÑ∏Ïä§Î•º Í¥ÄÎ¶¨Ìï† Ïàò ÏûàÏäµÎãàÎã§.
          {totalItems > 0 && ` Ï¥ù ${totalItems.toLocaleString()}Í±¥Ïùò ÏöîÏ≤≠Ïù¥ ÏûàÏäµÎãàÎã§.`}
        </PageSubtitle>
      </PageHeader>

      {/* üé® Í∞úÏÑ†Îêú ÌÜµÍ≥Ñ Ïπ¥Îìú (Îëê Î≤àÏß∏ ÏΩîÎìú Ïä§ÌÉÄÏùº) */}
      <StatsContainer>
        <StatCard $color="#3b82f6">
          <div className="stat-header">
            <FileText size={24} />
            <span>Ï†ÑÏ≤¥ ÏöîÏ≤≠</span>
          </div>
          <div className="stat-value">{totalRequests.toLocaleString()}</div>
          <div className="stat-label">Ï¥ù Íµ¨Îß§ ÏöîÏ≤≠</div>
          {stats.this_month > 0 && (
            <div className="stat-change positive">
              Ïù¥Î≤à Îã¨ +{stats.this_month}
            </div>
          )}
        </StatCard>

        <StatCard $color="#f59e0b">
          <div className="stat-header">
            <Clock size={24} />
            <span>ÏäπÏù∏ ÎåÄÍ∏∞</span>
          </div>
          <div className="stat-value">{pendingRequests.toLocaleString()}</div>
          <div className="stat-label">Ï≤òÎ¶¨ ÎåÄÍ∏∞Ï§ë</div>
        </StatCard>

        <StatCard $color="#10b981">
          <div className="stat-header">
            <Check size={24} />
            <span>ÏäπÏù∏ ÏôÑÎ£å</span>
          </div>
          <div className="stat-value">{completedRequests.toLocaleString()}</div>
          <div className="stat-label">ÏäπÏù∏Îêú ÏöîÏ≤≠</div>
        </StatCard>

        <StatCard $color="#ef4444">
          <div className="stat-header">
            <X size={24} />
            <span>Í±∞Ï†àÎê®</span>
          </div>
          <div className="stat-value">{rejectedRequests.toLocaleString()}</div>
          <div className="stat-label">Í±∞Ï†àÎêú ÏöîÏ≤≠</div>
        </StatCard>
      </StatsContainer>

      <ContentCard>
        <FilterSection>
          <FilterContainer>
            <PurchaseRequestFilters onFilter={handleFilterChange} />
            
            <ActionButtons>
              <Button
                variant="outline"
                onClick={handleRefresh}
                disabled={isLoading}
                size="sm"
                title="ÏÉàÎ°úÍ≥†Ïπ®"
              >
                <RefreshCw size={16} />
                <span>ÏÉàÎ°úÍ≥†Ïπ®</span>
              </Button>
              <Button
                variant="secondary"
                onClick={handleExport}
                disabled={exportMutation.isPending}
                loading={exportMutation.isPending}
                size="sm"
                title="Excel Îã§Ïö¥Î°úÎìú"
              >
                <Download size={16} />
                <span>Excel Îã§Ïö¥Î°úÎìú</span>
              </Button>
              <Button
                variant="outline"
                onClick={() => setIsExcelModalOpen(true)}
                size="sm"
                title="Excel ÏùºÍ¥Ñ ÏóÖÎ°úÎìú"
              >
                <Upload size={16} />
                <span>Excel ÏóÖÎ°úÎìú</span>
              </Button>
              <Button 
                onClick={() => setIsFormModalOpen(true)}
                size="sm"
                title="Íµ¨Îß§ ÏöîÏ≤≠ Ï∂îÍ∞Ä"
              >
                <Plus size={16} />
                <span>Íµ¨Îß§ ÏöîÏ≤≠</span>
              </Button>
            </ActionButtons>
          </FilterContainer>
        </FilterSection>

        {/* ÌÖåÏù¥Î∏î Ïª®ÌÖåÏù¥ÎÑà */}
        <TableContainer>
          {requests.length === 0 && !isLoading ? (
            <EmptyState>
              <FileText size={48} className="empty-icon" />
              <div className="empty-title">Îì±Î°ùÎêú Íµ¨Îß§ ÏöîÏ≤≠Ïù¥ ÏóÜÏäµÎãàÎã§</div>
              <div className="empty-message">
                ÏÉàÎ°úÏö¥ Íµ¨Îß§ ÏöîÏ≤≠ÏùÑ Îì±Î°ùÌïòÏó¨ ÏãúÏûëÌï¥Î≥¥ÏÑ∏Ïöî.
              </div>
              <div style={{ display: 'flex', gap: '12px', justifyContent: 'center' }}>
                <Button onClick={() => setIsFormModalOpen(true)}>
                  <Plus size={16} />
                  Í∞úÎ≥Ñ Îì±Î°ù
                </Button>
                <Button variant="outline" onClick={() => setIsExcelModalOpen(true)}>
                  <Upload size={16} />
                  Excel ÏóÖÎ°úÎìú
                </Button>
              </div>
            </EmptyState>
          ) : (
            <>
              <Table
                columns={columns}
                data={requests}
                loading={isLoading}
                emptyMessage="Í≤ÄÏÉâ Ï°∞Í±¥Ïóê ÎßûÎäî Íµ¨Îß§ ÏöîÏ≤≠Ïù¥ ÏóÜÏäµÎãàÎã§."
              />

              {/* ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò */}
              {totalPages > 1 && (
                <Pagination
                  currentPage={currentPage}
                  totalPages={totalPages}
                  onPageChange={setCurrentPage}
                />
              )}
            </>
          )}
        </TableContainer>
      </ContentCard>

      {/* Íµ¨Îß§ ÏöîÏ≤≠ Îì±Î°ù/ÏàòÏ†ï Î™®Îã¨ */}
      <Modal
        isOpen={isFormModalOpen}
        onClose={handleFormCancel}
        title={editingRequest ? 'Íµ¨Îß§ ÏöîÏ≤≠ ÏàòÏ†ï' : 'ÏÉà Íµ¨Îß§ ÏöîÏ≤≠ Îì±Î°ù'}
        size="xl"
      >
        <PurchaseRequestForm
          onSuccess={handleFormSuccess}
          onCancel={handleFormCancel}
          initialData={editingRequest || undefined}
          isEdit={!!editingRequest}
        />
      </Modal>

      {/* Excel ÏùºÍ¥Ñ ÏóÖÎ°úÎìú Î™®Îã¨ */}
      <ExcelBulkUpload
        isOpen={isExcelModalOpen}
        onClose={() => setIsExcelModalOpen(false)}
        onSuccess={handleExcelSuccess}
      />

      {/* ÏÉÅÏÑ∏Î≥¥Í∏∞ Î™®Îã¨ */}
      {viewingRequest && (
        <RequestDetailModal
          request={viewingRequest}
          isOpen={isDetailModalOpen}
          onClose={() => {
            setIsDetailModalOpen(false);
            setViewingRequest(null);
          }}
          onEdit={() => {
            setEditingRequest(viewingRequest);
            setIsFormModalOpen(true);
            setIsDetailModalOpen(false);
            setViewingRequest(null);
          }}
        />
      )}

      {/* üî• Íµ¨Îß§ÏôÑÎ£å ÌôïÏù∏ Îã§Ïù¥ÏñºÎ°úÍ∑∏ (Ï≤´ Î≤àÏß∏ ÏΩîÎìú Ïä§ÌÉÄÏùº) */}
      {confirmingItem && (
        <ConfirmDialog onClick={cancelPurchaseComplete}>
          <ConfirmContent onClick={(e) => e.stopPropagation()}>
            <div className="confirm-icon">
              <Package2 size={32} />
            </div>
            
            <div className="confirm-title">Íµ¨Îß§ÏôÑÎ£å + ÌíàÎ™©Îì±Î°ù</div>
            
            <div className="confirm-message">
              ÏïÑÎûò Íµ¨Îß§ ÏöîÏ≤≠ÏùÑ ÏôÑÎ£åÌïòÍ≥† ÌíàÎ™©Í¥ÄÎ¶¨Ïóê Îì±Î°ùÌïòÏãúÍ≤†ÏäµÎãàÍπå?
            </div>
            
            <div className="confirm-message" style={{ color: '#10b981', fontWeight: 'bold' }}>
              ‚ú® 1) Íµ¨Îß§ ÏöîÏ≤≠ ÏÉÅÌÉúÎ•º 'ÏôÑÎ£å'Î°ú Î≥ÄÍ≤Ω<br/>
              ‚ú® 2) ÌíàÎ™©Í¥ÄÎ¶¨Ïóê ÏûêÎèô Îì±Î°ù ÌõÑ Ìï¥Îãπ ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
            </div>
            
            <div className="item-info">
              <div className="info-row">
                <span className="label">ÌíàÎ™©Î™Ö:</span>
                <span className="value">{confirmingItem.item_name}</span>
              </div>
              <div className="info-row">
                <span className="label">ÏàòÎüâ:</span>
                <span className="value" style={{ display: 'inline', whiteSpace: 'nowrap' }}>
                  {confirmingItem.quantity}&nbsp;{confirmingItem.unit || 'Í∞ú'}
                </span>
              </div>
              <div className="info-row">
                <span className="label">ÏöîÏ≤≠Ïûê:</span>
                <span className="value">{confirmingItem.requester_name}</span>
              </div>
              <div className="info-row">
                <span className="label">Î∂ÄÏÑú:</span>
                <span className="value">{confirmingItem.department}</span>
              </div>
              {confirmingItem.total_budget && (
                <div className="info-row">
                  <span className="label">ÏòàÏÇ∞:</span>
                  <span className="value">{confirmingItem.total_budget.toLocaleString()}Ïõê</span>
                </div>
              )}
              <div className="info-row">
                <span className="label">ÏÉùÏÑ±Îê† ÌíàÎ™©ÏΩîÎìú:</span>
                <span className="value" style={{ color: '#3b82f6', fontWeight: 'bold' }}>
                  ITM-{new Date().toISOString().split('T')[0].replace(/-/g, '')}-{confirmingItem.id.toString().padStart(4, '0')}
                </span>
              </div>
            </div>
            
            <div className="button-group">
              <Button 
                variant="outline" 
                onClick={cancelPurchaseComplete}
                size="lg"
              >
                Ï∑®ÏÜå
              </Button>
              <Button 
                onClick={confirmPurchaseComplete}
                size="lg"
                loading={completePurchaseMutation.isPending}
                disabled={completePurchaseMutation.isPending}
                style={{
                  background: 'linear-gradient(135deg, #3b82f6, #1d4ed8)',
                  border: 'none'
                }}
              >
                <Package2 size={18} />
                Íµ¨Îß§ÏôÑÎ£å + ÌíàÎ™©Îì±Î°ù
              </Button>
            </div>
          </ConfirmContent>
        </ConfirmDialog>
      )}
    </Container>
  );
};

export default PurchaseRequestPage;